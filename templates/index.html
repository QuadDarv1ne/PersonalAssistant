<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–õ–∏—á–Ω—ã–π –ê—Å—Å–∏—Å—Ç–µ–Ω—Ç</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .history {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 10px;
            margin-bottom: 20px;
            background-color: #fafafa;
        }
        .entry {
            margin-bottom: 15px;
            padding: 10px;
            border-left: 3px solid #007bff;
            background: white;
        }
        .user { border-left-color: #28a745; }
        .assistant { border-left-color: #007bff; }
        .timestamp {
            color: #666;
            font-size: 0.8em;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background: #0056b3;
        }
        .status {
            padding: 10px;
            margin-bottom: 20px;
            border-radius: 4px;
        }
        .status.online { background: #d4edda; color: #155724; }
        .status.offline { background: #f8d7da; color: #721c24; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéôÔ∏è –õ–∏—á–Ω—ã–π –ì–æ–ª–æ—Å–æ–≤–æ–π –ê—Å—Å–∏—Å—Ç–µ–Ω—Ç</h1>

        <div id="status" class="status offline">
            –°—Ç–∞—Ç—É—Å: –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–µ –∑–∞–ø—É—â–µ–Ω–æ –ª–æ–∫–∞–ª—å–Ω–æ
        </div>

        <div class="history" id="history">
            <!-- –ò—Å—Ç–æ—Ä–∏—è —Ä–∞–∑–≥–æ–≤–æ—Ä–æ–≤ –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω–∞ –∑–¥–µ—Å—å -->
        </div>

        <div style="margin-bottom: 20px;">
            <input type="text" id="messageInput" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." style="width: 70%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
            <button onclick="sendMessage()" style="padding: 10px 20px;">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
        </div>

        <button onclick="loadHistory()">–û–±–Ω–æ–≤–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é</button>
        <button onclick="clearHistory()">–û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é</button>
    </div>

    <script>
        async function loadHistory() {
            try {
                const response = await fetch('/api/history');
                const history = await response.json();

                const historyDiv = document.getElementById('history');
                historyDiv.innerHTML = '';

                history.forEach(entry => {
                    const entryDiv = document.createElement('div');
                    entryDiv.className = 'entry user';
                    entryDiv.innerHTML = `
                        <div class="timestamp">${new Date(entry.timestamp).toLocaleString('ru-RU')}</div>
                        <strong>–í—ã:</strong> ${entry.user}
                    `;

                    const assistantDiv = document.createElement('div');
                    assistantDiv.className = 'entry assistant';
                    assistantDiv.innerHTML = `
                        <strong>–ê—Å—Å–∏—Å—Ç–µ–Ω—Ç:</strong> ${entry.assistant}
                    `;

                    historyDiv.appendChild(entryDiv);
                    historyDiv.appendChild(assistantDiv);
                });

                document.getElementById('status').className = 'status online';
                document.getElementById('status').textContent = '–°—Ç–∞—Ç—É—Å: –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–ø—É—â–µ–Ω–æ';

            } catch (error) {
                document.getElementById('status').className = 'status offline';
                document.getElementById('status').textContent = '–°—Ç–∞—Ç—É—Å: –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è';
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏:', error);
            }
        }

        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            if (!message) return;

            input.value = '';
            input.disabled = true;

            try {
                const response = await fetch('/api/send_message', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message })
                });
                const data = await response.json();
                if (data.response) {
                    loadHistory(); // –û–±–Ω–æ–≤–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é –ø–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏
                } else if (data.error) {
                    alert(data.error);
                }
            } catch (error) {
                alert('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è');
                console.error(error);
            } finally {
                input.disabled = false;
                input.focus();
            }
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ Enter –≤ –ø–æ–ª–µ –≤–≤–æ–¥–∞
        document.getElementById('messageInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        loadHistory();

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥
        setInterval(loadHistory, 5000);
    </script>
</body>
</html>